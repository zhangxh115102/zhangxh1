package com.shsunedu.api;

import java.util.Date;
import java.util.List;

import javax.annotation.Resource;

import org.apache.commons.lang.StringUtils;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.shsunedu.base.api.service.IOpenCourseService;
import com.shsunedu.base.api.util.EnumUtil.OpenCourseStatus;
import com.shsunedu.base.api.vo.OpenCourseVo;
import com.shsunedu.security.AuthWhite;
import com.shsunedu.tool.JsonUtil;

/**
 * 类名: OpenCourseApi<br>
 * 描述: 公开课<br>
 * 时间: 2017年6月15日 下午3:32:18 
 * @author: star 
*/
@RestController
@RequestMapping("/openCourse")
public class OpenCourseApi extends BaseApi {
    @Resource
    IOpenCourseService openCourseService;

    /**
     * 方法名: listOpenCourse<br>
     * 描述: 公开课<br>
     * 时间: 2017年6月28日下午5:59:23
     * @author: star
     * @param openCoursevo
     * @return String
     */
    @AuthWhite
    @RequestMapping("/listOpenCourse")
    public String listOpenCourse(OpenCourseVo openCoursevo) {
        Date nowDate = new Date();
        JsonUtil jsonUtil = new JsonUtil();
        try {
            @SuppressWarnings("unchecked")
            List<OpenCourseVo> list = (List<OpenCourseVo>) openCourseService.listAppPage(openCoursevo).getResult();
            for (OpenCourseVo openCourseVo2 : list) {
                if (openCourseVo2.getEndTime() < nowDate.getTime()&&StringUtils.isNotBlank(openCourseVo2.getMediaUri())) {
                    openCourseVo2.setStatus(OpenCourseStatus.PLAYBACK.getValue());
                }
                if (openCourseVo2.getEndTime() < nowDate.getTime()&&!StringUtils.isNotBlank(openCourseVo2.getMediaUri())) {
                    openCourseVo2.setStatus(OpenCourseStatus.ISEND.getValue());
                }
                if (openCourseVo2.getStartTime()-(30*60*1000)> nowDate.getTime()) {
                    openCourseVo2.setStatus(OpenCourseStatus.WILLBEGIN.getValue());
                }
                if (openCourseVo2.getStartTime()-(30*60*1000)< nowDate.getTime()&&openCourseVo2.getEndTime() < nowDate.getTime()) {
                    openCourseVo2.setStatus(OpenCourseStatus.INLESSON.getValue());
                }
            }
            jsonUtil.addToRoot("listCourses", list);
            return jsonUtil.toSuccessString();
        } catch (Exception e) {
            e.printStackTrace();
            return jsonUtil.toErrorString(e.getMessage());
        }
    }
}
